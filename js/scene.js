import*as i from"./_snowpack/pkg/three.js";import*as M from"./_snowpack/pkg/three/addons.js";import{SolarSystem as A}from"./solarSystem.js";import{ExoplanetSystem as I}from"./exoplanetSystem.js";import{SceneCamera as R}from"./sceneCamera.js";import*as v from"./observatories.js";const x=-160;let h=!1,g,S,w,p,t,y,f={x:.5,y:.5},l,u,m;export async function initHomeScene(e,a,r=!1){return h?!1:(h=!0,await C(e,r),await showHomeStateAsync(a),O(w),!0)}export async function initObservatoriesScene(e,a,r=!1){return h?!1:(h=!0,await C(e,r),v.addObservatoriesData(a),v.renderObservatories(S,u),await showObservatoriesStateAsync(!0,!1),O(w),!0)}export async function showHomeStateAsync(e,a=!0){await E(e),t.resetControlsDistance(),t.IsDirectOnPlanet=!1,setIsFocusActivePlanetOnScene(!1,a),P(d.Home)}export async function showObservatoriesStateAsync(e,a=!0){F();const r=l.getPlanetRadius();if(t.Controls.minDistance=r*1.5,t.Controls.maxDistance=r*2,e)t.IsDirectOnPlanet=!0,setIsFocusActivePlanetOnScene(!0,a);else{t.IsFocusOnScene=!1;const s=l.Planet.getWorldPosition(new i.Vector3);var n=new i.Vector3(s.x-r*2,s.y,s.z),c=(s.x-n.x)*Math.tan(45*Math.PI/180),o=new i.Vector3(s.x,s.y+c,s.z);t.changeCameraSettings(n,o,a)}P(e?d.ObservatoryEarth:d.ObservatorySpace)}export function setIsFocusActivePlanetOnScene(e,a=!0){t.IsFocusOnScene=e;const r=G(t.IsDirectOnPlanet);t.changeCameraSettings(r.position,r.lookAt,a)}async function E(e){u.hide(),m.show(),await m.prepareAsync(e),l=m}function F(){m.hide(),u.show(),l=u}function P(e){y=e,S.style.display=y!=d.ObservatoryEarth?"none":""}async function C(e,a=!1){globalThis.isDebug=a,g=document.querySelector(e),S=document.querySelector("#earth-observatories-labels"),w=new i.WebGLRenderer({antialias:!0,canvas:g,alpha:!0}),w.setPixelRatio(window.devicePixelRatio);{p=new i.Scene;const n=await new i.TextureLoader().loadAsync("images/image_background_stars.jpg");n.mapping=i.EquirectangularReflectionMapping,n.colorSpace=i.SRGBColorSpace,p.background=n}{const n=new i.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,2e3);p.add(n);const c=new M.OrbitControls(n,g);c.target.set(0,0,0),c.dampingFactor=.2,c.enableDamping=!0,t=new R(n,c)}{const n=new i.AmbientLight("#ffffff",.1);p.add(n)}const r=new W;u=new A,await u.initAsync(),r.positionGroup(u),p.add(u),m=new I,await m.initAsync(),r.positionGroup(m),p.add(m),window.addEventListener("mousemove",T,!1)}function O(e){requestAnimationFrame(a);function a(n){const c=n*.001;if(r()){const o=e.domElement;t.Camera.aspect=o.clientWidth/o.clientHeight,t.Camera.updateProjectionMatrix()}if(y!=d.ObservatoryEarth&&u.animate(n),m.animate(n),!t.CameraAnimator?.update(n)){if(!t.IsFocusOnScene){const o=t.Controls.target,s=new i.Vector3(o.x+(Math.abs(o.z-t.Camera.position.z)<1e7?0:(.5-f.x)/100),o.y+(.5-f.y)/100,o.z+(f.x-.5)/100);Math.abs(t.FocusedCameraTarget.x-s.x)<=l.getPlanetRadius()/10&&(o.x=s.x),Math.abs(t.FocusedCameraTarget.y-s.y)<=l.getPlanetRadius()/10&&(o.y=s.y),Math.abs(t.FocusedCameraTarget.z-s.z)<=l.getPlanetRadius()/10&&(o.z=s.z),t.Controls.target.copy(o)}t.Controls.update()}y==d.ObservatoryEarth&&v.updateObservatoriesLabels(g,t.Camera,u),e.render(p,t.Camera),requestAnimationFrame(a)}function r(){const n=e.domElement,c=n.clientWidth,o=n.clientHeight,s=n.width!==c||n.height!==o;return s&&e.setSize(c,o,!1),s}}function G(e){const a=l.Planet.getWorldPosition(new i.Vector3),r=l.getPlanetRadius();let n=2*r*(e?-1:Math.sin(x*Math.PI/180)),c=e?0:2*r*Math.cos(x*Math.PI/180),o={x:0,z:0};if(!e&&!t.IsFocusOnScene){const b=90-(180-Math.abs(x));o.x=l.getPlanetRadius()*Math.sin(b*Math.PI/180),o.z=l.getPlanetRadius()*Math.cos(b*Math.PI/180)}var s=new i.Vector3(a.x+n-o.x,a.y,a.z+c+o.z),z=new i.Vector3(a.x-o.x,a.y,a.z+o.z);return{position:s,lookAt:z}}function T(e){f.x=e.clientX/window.innerWidth,f.y=e.clientY/window.innerHeight}class W{constructor(){this.sceneGroupXPosition=0,this.sceneGroupXPositionIncrementor=1e4}positionGroup(a){a.position.set(this.sceneGroupXPosition++*this.sceneGroupXPositionIncrementor,0,0)}}var d;(function(e){e[e.Home=0]="Home",e[e.ObservatoryEarth=1]="ObservatoryEarth",e[e.ObservatorySpace=2]="ObservatorySpace"})(d||(d={}));
