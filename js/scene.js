import*as s from"./_snowpack/pkg/three.js";import*as A from"./_snowpack/pkg/three/addons.js";import{SolarSystem as M}from"./solarSystem.js";import{ExoplanetSystem as F}from"./exoplanetSystem.js";import{SceneCamera as I}from"./sceneCamera.js";import*as b from"./observatories.js";const S=-160;let h=!1,g,x,w,d,t,v,y={x:.5,y:.5},u,l,m;export async function initHomeScene(e,a,r=!1){return h?!1:(h=!0,await O(e,r),await showHomeStateAsync(a),P(w),!0)}export async function initObservatoriesScene(e,a,r=!1){return h?!1:(h=!0,await O(e,r),b.renderObservatories(a,x,l),await showObservatoriesStateAsync(!0,!1),P(w),!0)}export async function initFreeCameraScene(e,a=!1){return h?!1:(h=!0,await O(e,a),await showFreeCameraStateAsync(),P(w),!0)}export async function showHomeStateAsync(e,a=!0){await R(e),t.resetControlsDistance(),t.IsDirectOnPlanet=!1,setIsFocusActivePlanetOnScene(!1,a),C(f.Home)}export async function showObservatoriesStateAsync(e,a=!0){T();const r=u.getPlanetRadius();if(t.Controls.minDistance=r*1.5,t.Controls.maxDistance=r*2,e)t.IsDirectOnPlanet=!0,setIsFocusActivePlanetOnScene(!0,a);else{t.IsFocusOnScene=!1;const o=u.Planet.getWorldPosition(new s.Vector3);var n=new s.Vector3(o.x-r*2,o.y,o.z),c=(o.x-n.x)*Math.tan(45*Math.PI/180),i=new s.Vector3(o.x,o.y+c,o.z);t.changeCameraSettings(n,i,a)}C(e?f.ObservatoryEarth:f.ObservatorySpace)}export async function showFreeCameraStateAsync(e=!0){t.IsFocusOnScene=!1,t.changeCameraSettings(new s.Vector3(2e4,2e4,2e4),new s.Vector3(2e4+10,2e4+10,2e4+10),e),C(f.Home)}export async function showObservatoriesStateFirstTimeAsync(e){b.renderObservatories(e,x,l),await showObservatoriesStateAsync(!0,!1)}export function setIsFocusActivePlanetOnScene(e,a=!0){t.IsFocusOnScene=e;const r=E(t.IsDirectOnPlanet);t.changeCameraSettings(r.position,r.lookAt,a)}export function passDotNet(e){globalThis.dotNet=e}async function R(e){l.hide(),m.show(),await m.prepareAsync(e),u=m}function T(){m.hide(),l.show(),u=l}function C(e){v=e,x.style.display=v!=f.ObservatoryEarth?"none":""}async function O(e,a=!1){globalThis.isDebug=a,g=document.querySelector(e),x=document.querySelector("#earth-observatories-labels"),w=new s.WebGLRenderer({antialias:!0,canvas:g,alpha:!0}),w.setPixelRatio(window.devicePixelRatio);{d=new s.Scene;const n=await new s.TextureLoader().loadAsync("images/image_background_stars.jpg");n.mapping=s.EquirectangularReflectionMapping,n.colorSpace=s.SRGBColorSpace,d.background=n}{const n=new s.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,2e3);d.add(n);const c=new A.OrbitControls(n,g);c.target.set(0,0,0),c.dampingFactor=.2,c.enableDamping=!0,t=new I(n,c)}{const n=new s.AmbientLight("#ffffff",.1);d.add(n)}const r=new H;l=new M,await l.initAsync(),r.positionGroup(l),d.add(l),m=new F,await m.initAsync(),r.positionGroup(m),d.add(m),window.addEventListener("mousemove",G,!1)}function P(e){requestAnimationFrame(a);function a(n){const c=n*.001;if(r()){const o=e.domElement;t.Camera.aspect=o.clientWidth/o.clientHeight,t.Camera.updateProjectionMatrix()}if(v!=f.ObservatoryEarth&&l.animate(n),m.animate(n),!t.CameraAnimator?.update(n)){if(!t.IsFocusOnScene){const o=t.Controls.target,p=new s.Vector3(o.x+(Math.abs(o.z-t.Camera.position.z)<1e7?0:(.5-y.x)/100),o.y+(.5-y.y)/100,o.z+(y.x-.5)/100);var i=u?.getPlanetRadius()??2;Math.abs(t.FocusedCameraTarget.x-p.x)<=i/10&&(o.x=p.x),Math.abs(t.FocusedCameraTarget.y-p.y)<=i/10&&(o.y=p.y),Math.abs(t.FocusedCameraTarget.z-p.z)<=i/10&&(o.z=p.z),t.Controls.target.copy(o)}t.Controls.update()}v==f.ObservatoryEarth&&b.updateObservatoriesLabels(g,t.Camera,l),e.render(d,t.Camera),requestAnimationFrame(a)}function r(){const n=e.domElement,c=n.clientWidth,i=n.clientHeight,o=n.width!==c||n.height!==i;return o&&e.setSize(c,i,!1),o}}function E(e){const a=u.Planet.getWorldPosition(new s.Vector3),r=u.getPlanetRadius();let n=2*r*(e?-1:Math.sin(S*Math.PI/180)),c=e?0:2*r*Math.cos(S*Math.PI/180),i={x:0,z:0};if(!e&&!t.IsFocusOnScene){const z=90-(180-Math.abs(S));i.x=u.getPlanetRadius()*Math.sin(z*Math.PI/180),i.z=u.getPlanetRadius()*Math.cos(z*Math.PI/180)}var o=new s.Vector3(a.x+n-i.x,a.y,a.z+c+i.z),p=new s.Vector3(a.x-i.x,a.y,a.z+i.z);return{position:o,lookAt:p}}function G(e){y.x=e.clientX/window.innerWidth,y.y=e.clientY/window.innerHeight}class H{constructor(){this.sceneGroupXPosition=0,this.sceneGroupXPositionIncrementor=1e4}positionGroup(a){a.position.set(this.sceneGroupXPosition++*this.sceneGroupXPositionIncrementor,0,0)}}var f;(function(e){e[e.Home=0]="Home",e[e.ObservatoryEarth=1]="ObservatoryEarth",e[e.ObservatorySpace=2]="ObservatorySpace",e[e.FreeCamera=3]="FreeCamera"})(f||(f={}));
